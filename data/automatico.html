<!doctype html>
<html lang="es">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>ESP32</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Bungee+Spice&family=Righteous&display=swap" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
        <script src="http://cdn.rawgit.com/Mikhus/canvas-gauges/gh-pages/download/2.1.7/all/gauge.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css">
    </head>
    <body>
        
        <div class="container-fluid text-center">
            <div class="row">
                <div class="col align-items-center d-flex">
                    <img src="https://ucblpz.com/wp-content/uploads/2018/12/UCB-logo-lapaz.png" class="img-fluid">
                </div>
                <div class='col mt-5'>
                    <h1>ESP32 Juernes</h1>
                </div>
                <div class="col">
                    <img src="https://raw.githubusercontent.com/3m3rs0n/Security/main/logo.png"  width="200" alt="">
                </div>
            </div>
        </div>
        <hr>

        <ul class="nav justify-content-center">
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="/">TEST</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/MANUAL">MANUAL</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/AUTOMATICO">AUTOMATICO</a>
            </li>
        </ul>

        <hr>

        <h1 class="text-center">MODO AUTOMATICO</h1>

        <hr>

        <h1 class="text-center">ESTADO DEL BRAZO</h1>
        <div class="container text-center">
            <div class="row">
                <div class="col">
                    <h2>PLATAFORMA</h2>
                    <img src="https://github.com/EmersonChipana/Datos/blob/main/eje.png?raw=true" id="rueda" class="rueda" alt="" width="300">
                </div>
                <div class="col">
                    <h2>Brazo</h2>
                    <img src="https://cdn-icons-png.flaticon.com/512/44/44674.png" alt="" id="brazo"class="brazo mt-3" width="250">

                </div>
                <div class="col">
                    <h2>BRAZO</h2>
                    <img src="https://github.com/EmersonChipana/Datos/blob/main/brazo2.png?raw=true" alt="" id="brazo2" class="brazo2 mt-3" width="250">
                </div>
                <div class="col">
                    <h2>GARRA</h2>
                    <img src="https://cdn-icons-png.flaticon.com/512/44/44707.png" width="250" class="garra mt-3" id="garra">
                </div>
            </div>
        </div>

        <hr>
        
        <div class="container w-50">
            <div class="row mb-5">
                <label for="motor" class="form-label" id="lableMotor">Base del motor</label>
                <input type="range" class="form-range" min="0" max="180" id="motor" onchange="setValor(this.value)">
            </div>
            <h2 class="text-center" id="valor">Valor: </h2>
            <div class="row mt-5">
                <select class="form-select" aria-label="Default select example" onchange="setLabel()">
                    <option value="0" selected>Base del robot</option>
                    <option value="1">Brazo 1</option>
                    <option value="2">Brazo 2</option>
                    <option value="3">Garra</option>
                </select>
            </div>
            <div class="row text-center">
                <button type="button" class="btn btn-primary mt-5" id="btn1" onclick="enviar()">AGREGAR</button>
            </div>
        </div>
        
        <hr>

        <h1 class="text-center">Instrucciones</h1>
        <div class="container text-center w-50">
            <div class="row">
                <table class="table table-light table-striped" id="instrucciones">
                    <thead>
                        <tr>
                        <th scope="col">#</th>
                        <th scope="col">MOTOR</th>
                        <th scope="col">VALOR</th>
                        </tr>
                    </thead>
                    <tbody>

                    </tbody>
                </table>
            </div>
        </div>
        <hr>

        <div class="container w-50">
            <div class="row text-center">
                <button type="button" class="btn btn-primary" id="btn1" onclick="iniciarInstrucciones()">INICIAR</button>
            </div>
        </div>
        <hr>
       

        <h1 class="text-center">Datos de conexi√≥n</h1>

        <div class="container text-center">
            <div class="row">
                <div class="col">
                    <h1>NOMBRE</h1>
                    <h3 id="ssid"></h3>
                </div>
                <div class="col">
                    <h1>POTENCIA</h1>
                    <canvas id="rssi"></canvas>
                </div>
                <div class="col">
                    <h1>IP</h1>
                    <h3 id="ip"></h3>
                </div>
                <div class="col">
                    <h1>ESTADO</h1>
                    <h3 id="status"></h3>
                </div>
            </div>
        </div>
        
        <hr>

        <div class="container-fluid text-center mt-5">
            <h1>Integrantes</h1>
            <div class="row">
                <div class="col">
                    <img src="https://github.com/EmersonChipana/Datos/blob/main/JesusMeriles.jpeg?raw=true" class="int-img" alt="">
                </div>
                <div class="col">
                    <img src="https://github.com/EmersonChipana/Datos/blob/main/CrisYanez.jpeg?raw=true"  class="int-img" alt="">
                </div>
                <div class="col">
                    <img src="https://lh3.googleusercontent.com/a-/ACNPEu9nN_VmsKrjWaC5JRkxeT1KXVJIxRPSpdsif2__=s288-p-rw-no" class="int-img" alt="">
                </div>
            </div>
        </div>

        
        <hr>
        <div class="barra">
            <small>IOT II-2022</small>
        </div>

        <script>
            var motores = [];
            var num = [];
            var valores = [];
            var contador = 0;

            var valoresMotores = [0,0,0,0];

            const time = 2000;

            function getValueMotor(){
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        var myObj = JSON.parse(this.responseText);
                        valoresMotores[0] = myObj.mot1;
                        valoresMotores[1] = myObj.mot2;
                        valoresMotores[2] = myObj.mot3;
                        valoresMotores[3] = myObj.mot4;
                    }
                }; 
                xhr.open("GET", "/VALORES", true);
                xhr.send();

            }

            getValueMotor();

            var rssid = new RadialGauge({
                renderTo: 'rssi',
                width: 200,
                height: 200,
                units: "dB",
                title: "Potencia WIFI",
                minValue: -80,
                maxValue: 0,
                majorTicks: [
                    -80,
                    -70,
                    -60,
                    -50,
                    -40,
                    -30,
                    -20,
                    -10,
                    0,
                ],
                minorTicks: 2,
                strokeTicks: true,
                highlights: [
                    {
                        "from": -50,
                        "to": 0,
                        "color": "rgba(0,0, 255, .3)"
                    },
                    {
                        "from": 0,
                        "to": 50,
                        "color": "rgba(255, 0, 0, .3)"
                    }
                ],
                ticksAngle: 225,
                startAngle: 67.5,
                colorMajorTicks: "#ddd",
                colorMinorTicks: "#ddd",
                colorTitle: "#eee",
                colorUnits: "#ccc",
                colorNumbers: "#eee",
                colorPlate: "#222",
                borderShadowWidth: 0,
                borders: true,
                needleType: "arrow",
                needleWidth: 2,
                needleCircleSize: 7,
                needleCircleOuter: true,
                needleCircleInner: false,
                animationDuration: 1500,
                animationRule: "linear",
                colorBorderOuter: "#333",
                colorBorderOuterEnd: "#111",
                colorBorderMiddle: "#222",
                colorBorderMiddleEnd: "#111",
                colorBorderInner: "#111",
                colorBorderInnerEnd: "#333",
                colorNeedleShadowDown: "#333",
                colorNeedleCircleOuter: "#333",
                colorNeedleCircleOuterEnd: "#111",
                colorNeedleCircleInner: "#111",
                colorNeedleCircleInnerEnd: "#222",
                valueBoxBorderRadius: 0,
                colorValueBoxRect: "#222",
                colorValueBoxRectEnd: "#333"
            }).draw();

            const ssid = document.getElementById("ssid");
            const ip = document.getElementById("ip");
            const st = document.getElementById("status");

            function getDataConexion(){
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        var myObj = JSON.parse(this.responseText);
                        ssid.textContent = myObj.ssid;
                        ip.textContent = myObj.dip;
                        st.textContent = myObj.status
                        rssid.value = myObj.rsid;
                    }
                }; 
                xhr.open("GET", "/INFO", true);
                xhr.send();
            }

            setInterval(getDataConexion, 10000);

            function setValor(valor){
                document.getElementById("valor").innerHTML = "Valor: " + valor;
            }


            function setLabel(){
                var select = document.getElementById("lableMotor");
                var index = document.getElementsByTagName("select")[0].value;
                if(index == 0){
                    select.textContent = "Base del robot";
                }else if(index == 1){
                    select.textContent = "Brazo 1";
                }else if(index == 2){
                    select.textContent = "Brazo 2";
                }else if(index == 3){
                    select.textContent = "Garra";
                }
            }

            function enviar(){
                var index = document.getElementsByTagName("select")[0].value;
                const valor = document.getElementById("motor").value;
                const motor = document.getElementById("lableMotor").textContent;
                motores.push(motor);
                valores.push(valor);
                num.push(parseInt(index)+1);
                setInstrucciones();
            }

            function setInstrucciones(){
                var table = document.getElementById("instrucciones");
                table.innerHTML="";
                for(let i=0; i<=motores.length-1; i++){
                    var row = table.insertRow(i);
                    var cell1 = row.insertCell(0);
                    var cell2 = row.insertCell(1);
                    var cell3 = row.insertCell(2);
                    var cell4 = row.insertCell(3);
                    cell1.innerHTML = i+1;
                    cell2.innerHTML = motores[i];
                    cell3.innerHTML = valores[i];
                    cell4.innerHTML = "<button class='btn btn-danger' onclick='eliminar(this)'>Eliminar</button>";
                }
               
            }

            function eliminar(btn){
                var row = btn.parentNode.parentNode;
                row.parentNode.removeChild(row);
                var index = row.rowIndex - 1;
                motores.splice(index, 1);
                valores.splice(index, 1);
                num.splice(index, 1);
                setInstrucciones();
            }

            function iniciarInstrucciones(){
                for(let i=0; i<=motores.length-1; i++){
                    setTimeout(() => {
                        const dataString = "motor=" + num[i] + "&valor=" + valores[i];
                        $.ajax({
                            type: "POST",
                            url: "/MOTOR"+num[i],
                            data: dataString
                        });
                        doAnimation(num[i], valores[i]);
                        const index = num[i]-1;
                        valoresMotores[index] = parseInt(valores[i]);
                        console.log(valoresMotores);
                    }, 5000*i);
                }
            }


            function doAnimation(num, valor){
                var valueMotor = valoresMotores[num];
                var flag = false;
                // Si el valor anterior es menor al actual true
                // Si el valor anterior es mayor al actual false
                if(valueMotor < valor){
                    flag = true;
                }
                switch (num){
                    case 1:
                        rotate();
                        break;
                    case 2:
                        if(flag==true){
                            upBrazo();
                        }else{
                            downBrazo();
                        }
                        break;
                    case 3:
                        if(flag==true){
                            rightBrazo2();
                        }else{
                            leftBrazo2();
                        }  
                        break;                      
                    case 4:
                        if(flag==true){
                            resizeSmall();
                        }else{
                            resizeBig();
                        }
                        break;
                }

            }
        

            function rotate(){
                const rueda = document.getElementById("rueda");
                rueda.style.animation = "rotateRight 2s infinite";
                rueda.style.webkitAnimation = "rotateRight 2s infinite";
                setTimeout(() => {
                    rueda.style.animationPlayState = "paused";
                    }, time);
            }

            function upBrazo(){
                const brazo = document.getElementById("brazo");
                brazo.src = "https://cdn-icons-png.flaticon.com/512/44/44674.png";
                brazo.style.animation = "up 2s infinite";
                brazo.style.webkitAnimation = "up 2s infinite infinite";
                setTimeout(() => {
                    brazo.style.animationPlayState = "paused";
                    }, time);
            }

            function downBrazo(){
                const brazo =document.getElementById("brazo");
                brazo.src ="https://www.pngmart.com/files/15/Vector-Arrow-Down-PNG-Transparent-Image.png";
                brazo.style.animation = "down 2s infinite";
                brazo.style.webkitAnimation = "down 2s infinite";
                setTimeout(() => {
                    brazo.style.animationPlayState = "paused";
                    }, time);
                
            }
                      
            function rightBrazo2(){
                const brazo2 = document.getElementById("brazo2");
                brazo2.src ="https://github.com/EmersonChipana/Datos/blob/main/brazo2.png?raw=true";
                brazo2.style.animation = "right 2s infinite";
                brazo2.style.webkitAnimation = "right 2s infinite";
                setTimeout(() => {
                    brazo2.style.animationPlayState = "paused";
                    }, time);
            }

            function leftBrazo2(){
                const brazo2 = document.getElementById("brazo2");
                brazo2.src = "https://www.pngmart.com/files/3/Left-Arrow-PNG-File.png";
                brazo2.style.animation = "left 2s infinite";
                brazo2.style.webkitAnimation = "left 2s infinite";
                setTimeout(() => {
                    brazo2.style.animationPlayState = "paused";
                    }, time);
            }

            function resizeSmall(){
                const garra = document.getElementById("garra");
                garra.src = "https://cdn-icons-png.flaticon.com/512/44/44707.png";
                garra.style.animation = "resizeSmall 2s infinite";
                garra.style.webkitAnimation = "resizeSmall 2s infinite";
                setTimeout(() => {
                    garra.style.animationPlayState = "paused";
                    }, time);
            }

            function resizeBig(){
                const garra = document.getElementById("garra");
                garra.src = "https://cdn-icons-png.flaticon.com/512/44/44755.png";
                garra.style.animation = "resizeBig 2s infinite";
                garra.style.webkitAnimation = "resizeBig 2s infinite";
                setTimeout(() => {
                    garra.style.animationPlayState = "paused";
                    }, time);
            }

            
        </script>
        

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8" crossorigin="anonymous"></script>
    </body>
</html>